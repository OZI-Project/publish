name: OZI Publish
description: "OZI publish action."
branding:
  icon: 'gift'
  color: 'yellow'
inputs:
  github-token:
    description: "GitHub workflow-generated token."
    required: false
    default: ${{ github.token }}
  create-pull-request:
    description: "Create a pull request on the default branch."
    default: false
  pull-request-body:
    description: "Text to use for the pull request body."
    default: "Created automatically. Manually close and reopen to enable checks."
runs:
  using: "composite"
  steps:
    - uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8

    - uses: actions/download-artifact@634f93cb2916e3fdff6788551b99b062d0335ce0

    - name: Move artifact
      run: cp -a artifact/. ./
      shell: bash

    - name: Publish package distributions to GitHub Releases
      uses: python-semantic-release/publish-action@ae6462adc12bd3d1738070d784b65b5189b955a9
      with:
        github_token: ${{ inputs.github-token }}

    - name: Get HEAD branch name
      id: head
      if: ${{ fromJSON(inputs.create-pull-request) == true }}
      run: git remote show origin | grep 'HEAD branch' | cut -d ":" -f2 | sed 's/ /name=/' >> $GITHUB_OUTPUT
      shell: bash

    - if: ${{ fromJSON(inputs.create-pull-request) == true && steps.head.outputs.name == github.ref_name }}
      run: echo 'already in HEAD branch no pull request will be created'
      shell: bash

    - name: Create pull request
      if: ${{ fromJSON(inputs.create-pull-request) == true && steps.head.outputs.name != github.ref_name }}
      run: gh pr create -B $HEAD_BRANCH -H $REF_NAME --title "Merge $REF_NAME into $HEAD_BRANCH" --body "$PR_BODY"
      env:
          HEAD_BRANCH: ${{ steps.head.outputs.name }}
          REF_NAME: ${{ github.head_ref || github.ref_name }}
          PR_BODY: ${{ inputs.pull-request-body }}
          GITHUB_TOKEN: ${{ inputs.github-token }}
      shell: bash
